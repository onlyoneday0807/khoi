<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, user-scalable=no"/>
  <title>R·∫ÆN RUBY ‚Äî Kh√¥ng nh·∫°c n·ªÅn</title>

  <style>
    :root{ --gap:10px; }
    html,body{ height:100%; margin:0; background:#0f1114; color:#fff; -webkit-tap-highlight-color: transparent; }
    body{
      display:flex; flex-direction:column; align-items:center;
      font-family:Segoe UI, Roboto, Arial; padding:12px; box-sizing:border-box;
      touch-action:none; overscroll-behavior:none;
    }
    h1{
      margin:6px 0 4px 0; font-size:20px; color:#ff6fa3;
      text-shadow:0 0 10px rgba(255,111,163,0.6); text-align:center;
    }
    #scoreBox{
      font-size:16px; margin-bottom:8px; color:#ffd87a;
      text-shadow:0 0 6px rgba(255,216,122,0.5); text-align:center; font-weight:600;
    }
    .controls{ display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap; justify-content:center; }
    button{ padding:8px 12px; border-radius:10px; border:0; background:#222; color:#fff; cursor:pointer; }
    #wrap{ display:flex; flex-direction:column; align-items:center; width:100%; max-width:480px; }
    canvas{ display:block; border-radius:12px; background:#141414; width:100%; box-shadow:0 8px 28px rgba(0,0,0,0.6); touch-action:none; }
    .note{ margin-top:8px; font-size:13px; color:#cfcfcf; text-align:center; }
    #highscorePanel{ margin-top:10px; width:100%; max-width:420px; color:#dfefff; text-align:center; }
    #highscorePanel b{ color:#ffe48a; }
    #highList{ margin:6px 0 0 0; padding:0; list-style:none; display:inline-block; text-align:left; }
    #highList li{ padding:4px 8px; border-radius:8px; background:rgba(255,255,255,0.03); margin-bottom:4px; min-width:220px; }
    .small{ font-size:13px; padding:6px 10px; }
  </style>
</head>

<body>

  <h1>üêç R·∫ÆN MINH KH√îI üêç</h1>

  <div id="scoreBox">ƒêi·ªÉm: 0 ‚Äî C·∫•p 1</div>

  <div class="controls">
    <button id="start">B·∫ÆT ƒê·∫¶U</button>
    <button id="pause">T·∫†M D·ª™NG</button>
    <button id="restart">CH∆†I L·∫†I</button>
  </div>

  <div id="wrap">
    <canvas id="game" aria-label="Game R·∫Øn Ruby"></canvas>
    <div class="note">Vu·ªët 4 h∆∞·ªõng ƒë·ªÉ ƒëi·ªÅu khi·ªÉn (ho·∫∑c ph√≠m m≈©i t√™n)</div>
  </div>

  <div id="highscorePanel">
    <div><b>TOP 5 B·∫£ng x·∫øp h·∫°ng</b></div>
    <ol id="highList"></ol>
  </div>

<script>
/* ============================
   Snake Ruby ‚Äî no background music
   ============================ */

/* ---------- Sounds ---------- */
const audioEat = new Audio("eat_mario.wav");
const audioDie = new Audio("die_mario.wav");

/* ---------- High score storage ---------- */
const HS_KEY = "snake_ruby_top5_v3";
function loadHighScores(){
  try {
    return JSON.parse(localStorage.getItem(HS_KEY) || "[]");
  } catch(e){ return []; }
}
function saveHighScores(list){
  localStorage.setItem(HS_KEY, JSON.stringify(list));
}
function updateHighListUI(){
  const ul = document.getElementById("highList");
  ul.innerHTML = "";
  const list = loadHighScores();
  if(list.length === 0){
    const li = document.createElement("li");
    li.textContent = "Ch∆∞a c√≥ k·ª∑ l·ª•c n√†o ‚Äî b·∫°n l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!";
    ul.appendChild(li);
    return;
  }
  list.forEach((entry, idx) => {
    const li = document.createElement("li");
    li.innerHTML = `${idx+1}. <b>${escapeHtml(entry.name)}</b> ‚Äî ${entry.score}`;
    ul.appendChild(li);
  });
}
function tryAddHighScore(score){
  const list = loadHighScores();
  if(list.length < 5 || score > list[list.length-1].score){
    let name = prompt("B·∫°n ƒë·∫°t TOP! Nh·∫≠p t√™n ƒë·ªÉ l∆∞u v√†o b·∫£ng x·∫øp h·∫°ng (t·ªëi ƒëa 20 k√Ω t·ª±):", "");
    if(name === null) name = "·∫®n Danh";
    name = String(name).trim().slice(0,20) || "·∫®n Danh";
    list.push({name, score});
    list.sort((a,b)=> b.score - a.score);
    saveHighScores(list.slice(0,5));
    updateHighListUI();
    return true;
  }
  return false;
}
function escapeHtml(s){
  return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* ---------- Canvas ---------- */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d", { alpha:false });

const RATIO_W = 9, RATIO_H = 16;
const TARGET_COLS = 18;

let CELL=20, COLS=TARGET_COLS, ROWS=0;
let snake=[], dir={x:1,y:0}, nextDir=null;
let food=null;
let score=0, level=1, speed=6;
let running=false, gameOver=false, lastTick=0;
let flashTimer=0, foodPulseTimer=0;

const headImg = new Image();
headImg.src = "ruby_head.png";

/* ---------- Resize ---------- */
function resizeCanvasAndGrid(reset=true){
  const maxWidth = Math.min(window.innerWidth-24, 480);
  let w = maxWidth;
  let h = Math.round(w*(RATIO_H/RATIO_W));

  const maxH = window.innerHeight - 180;
  if(h>maxH){ h=maxH; w=Math.round(h*(RATIO_W/RATIO_H)); }

  CELL = Math.floor(w/TARGET_COLS);
  if(CELL<8) CELL=8;

  COLS = Math.floor(w/CELL);
  ROWS = Math.floor(h/CELL);

  canvas.width = COLS*CELL;
  canvas.height = ROWS*CELL;
  canvas.style.width = canvas.width+"px";
  canvas.style.height = canvas.height+"px";

  if(reset) resetGame();
  else render();
}

/* ---------- Utility ---------- */
function randCell(){ return {x:Math.floor(Math.random()*COLS), y:Math.floor(Math.random()*ROWS)}; }
function eq(a,b){ return a&&b&&a.x===b.x && a.y===b.y; }

/* ---------- Food Placement ---------- */
function placeFood(){
  let f, tries=0;
  do{
    f=randCell(); tries++;
    if(tries>2000) break;
  }while(snake.some(s=>eq(s,f)));
  food=f;
}

/* ---------- Reset ---------- */
function resetGame(){
  snake=[{x:Math.floor(COLS/2), y:Math.floor(ROWS/2)}];
  dir={x:1,y:0}; nextDir=null;
  score=0; level=1; speed=6;
  running=false; gameOver=false;
  flashTimer=0; foodPulseTimer=0;
  updateScoreBox();
  placeFood();
  render();
}

/* ---------- Level Up ---------- */
function updateScoreBox(){
  document.getElementById("scoreBox").textContent = `ƒêi·ªÉm: ${score} ‚Äî C·∫•p ${level}`;
}
function checkLevelUp(){
  let newLevel = Math.floor(score/50)+1;
  if(newLevel!==level){
    level=newLevel;
    CELL=Math.min(44, CELL+2);
    resizeCanvasAndGrid(false);
  }
  updateScoreBox();
}

/* ---------- Game Update ---------- */
function update(){
  if(nextDir && !(nextDir.x===-dir.x && nextDir.y===-dir.y)) dir=nextDir;
  nextDir=null;

  const head={ x:snake[0].x+dir.x, y:snake[0].y+dir.y };

  if(head.x<0) head.x=COLS-1;
  if(head.x>=COLS) head.x=0;
  if(head.y<0) head.y=ROWS-1;
  if(head.y>=ROWS) head.y=0;

  if(snake.some(s=>eq(s,head))){
    running=false; gameOver=true;
    audioDie.currentTime=0; audioDie.play().catch(()=>{});
    tryAddHighScore(score);
    renderGameOver();
    return;
  }

  snake.unshift(head);

  if(eq(head,food)){
    score+=10;
    audioEat.currentTime=0; audioEat.play().catch(()=>{});
    flashTimer=10;
    foodPulseTimer=10;
    speed=Math.min(30, speed+0.4);
    placeFood();
    checkLevelUp();
  } else snake.pop();
}

/* ---------- Render ---------- */
function render(){
  ctx.fillStyle="#121212";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  /* ----- FOOD: v√†ng gradient nh·∫π, KH√îNG glow ----- */
  if(food){
    const px=food.x*CELL;
    const py=food.y*CELL;

    const g = ctx.createLinearGradient(px,py, px+CELL,py+CELL);
    g.addColorStop(0,"#ffe066");
    g.addColorStop(1,"#ffcc00");

    ctx.fillStyle=g;
    ctx.fillRect(px,py,CELL,CELL);

    ctx.strokeStyle="#c8a300";
    ctx.lineWidth=2;
    ctx.strokeRect(px+1,py+1,CELL-2,CELL-2);
  }

  /* body */
  for(let i=snake.length-1;i>0;i--){
    const s=snake[i];
    const pad=Math.max(1,Math.floor(CELL*0.08));
    ctx.fillStyle="#58d68d";
    ctx.fillRect(s.x*CELL+pad, s.y*CELL+pad, CELL-pad*2, CELL-pad*2);
  }

  /* head */
  if(snake.length){
    const h=snake[0];
    const px=h.x*CELL, py=h.y*CELL;

    let angle=0;
    if(dir.x===1) angle=0;
    if(dir.x===-1) angle=Math.PI;
    if(dir.y===-1) angle=-Math.PI/2;
    if(dir.y===1) angle=Math.PI/2;

    ctx.save();
    ctx.translate(px+CELL/2, py+CELL/2);
    ctx.rotate(angle);
    if(headImg.complete && headImg.naturalWidth)
      ctx.drawImage(headImg, -CELL/2, -CELL/2, CELL, CELL);
    else {
      const pad=4;
      ctx.fillStyle="#ff99cc";
      ctx.fillRect(-CELL/2+pad, -CELL/2+pad, CELL-pad*2, CELL-pad*2);
    }
    ctx.restore();
  }

  if(flashTimer>0){
    ctx.fillStyle=`rgba(255,255,255,${0.55*(flashTimer/10)})`;
    ctx.fillRect(0,0,canvas.width,canvas.height);
    flashTimer--;
  }

  if(foodPulseTimer>0) foodPulseTimer--;
}

/* ---------- Game Over ---------- */
function renderGameOver(){
  ctx.fillStyle="rgba(0,0,0,0.6)";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#ffdada";
  ctx.font=Math.max(18,Math.floor(CELL*1.1))+"px sans-serif";
  ctx.textAlign="center";
  ctx.fillText("GAME OVER", canvas.width/2, canvas.height/2-18);
  ctx.font=Math.max(12,Math.floor(CELL*0.6))+"px sans-serif";
  ctx.fillText("Nh·∫•n CH∆†I L·∫†I ƒë·ªÉ th·ª≠ l·∫°i", canvas.width/2, canvas.height/2+12);
}

/* ---------- Game Loop ---------- */
function loop(ts){
  if(!running) return;
  const interval=1000/speed;
  if(!lastTick) lastTick=ts;
  if(ts-lastTick>=interval){
    lastTick=ts;
    update();
    render();
  }
  requestAnimationFrame(loop);
}

/* ---------- Controls: Swipe + Keyboard ---------- */
let sx=0, sy=0, swiping=false;

canvas.addEventListener("touchstart", e=>{
  if(e.touches[0]){
    sx=e.touches[0].clientX;
    sy=e.touches[0].clientY;
    swiping=true;
  }
  e.preventDefault();
},{passive:false});

canvas.addEventListener("touchmove", e=>{
  e.preventDefault();
},{passive:false});

canvas.addEventListener("touchend", e=>{
  if(!swiping) return;
  swiping=false;

  const t=e.changedTouches[0];
  const dx=t.clientX-sx, dy=t.clientY-sy;
  const threshold = 20;

  if(Math.abs(dx)>Math.abs(dy)){
    if(dx>threshold)     nextDir={x:1,y:0};
    else if(dx<-threshold) nextDir={x:-1,y:0};
  } else {
    if(dy>threshold)     nextDir={x:0,y:1};
    else if(dy<-threshold) nextDir={x:0,y:-1};
  }

  if(gameOver){
    resetGame();
    running=true;
    lastTick=performance.now();
    requestAnimationFrame(loop);
  }
}, {passive:false});

window.addEventListener("keydown", e=>{
  if(e.key==="ArrowUp") nextDir={x:0,y:-1};
  if(e.key==="ArrowDown") nextDir={x:0,y:1};
  if(e.key==="ArrowLeft") nextDir={x:-1,y:0};
  if(e.key==="ArrowRight") nextDir={x:1,y:0};

  if(e.key===" "){
    if(gameOver) return;
    running=!running;
    if(running){
      lastTick=performance.now();
      requestAnimationFrame(loop);
    }
  }
});

/* ---------- Buttons ---------- */
document.getElementById("start").onclick=()=>{
  if(gameOver) resetGame();
  if(!running){
    running=true;
    lastTick=performance.now();
    requestAnimationFrame(loop);
  }
};

document.getElementById("pause").onclick=()=>{
  running=false;
};

document.getElementById("restart").onclick=()=>{
  resetGame();
  running=true;
  lastTick=performance.now();
  requestAnimationFrame(loop);
};

/* ---------- Init ---------- */
window.addEventListener("resize", ()=>resizeCanvasAndGrid(true));
resizeCanvasAndGrid(true);
updateHighListUI();
render();

</script>
</body>
</html>
